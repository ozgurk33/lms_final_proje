generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String             @id @default(uuid())
  username            String             @unique
  email               String             @unique
  password            String
  fullName            String?
  role                Role               @default(STUDENT)
  twoFactorSecret     String?
  twoFactorEnabled    Boolean            @default(false)
  googleId            String?            @unique
  isActive            Boolean            @default(true)
  emailVerified       Boolean            @default(false)
  isOfflineMode       Boolean            @default(false) // Preserving data
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  lastLogin           DateTime?
  grade               Int?
  auditLogs           AuditLog[]
  coursesAssigned     CourseInstructor[]
  coursesCreated      Course[]           @relation("InstructorCourses")
  enrollmentsAssigned Enrollment[]       @relation("EnrollmentAssignedBy")
  enrollments         Enrollment[]
  quizAttempts        QuizAttempt[]
  refreshTokens       RefreshToken[]
  submissions         AssignmentSubmission[]
  contentProgress     ContentProgress[]  // NEW: Track content progress
  notes               Note[]             // NEW: User notes
  omrSheetsCreated    OMRSheet[]         @relation("InstructorOMRSheets")
  omrSheetsStudent    OMRSheet[]         @relation("StudentOMRSheets")

  @@index([email])
  @@index([username])
  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("refresh_tokens")
}

model Course {
  id                    String             @id @default(uuid())
  title                 String
  description           String?
  category              String?
  thumbnail             String?
  instructorId          String
  isPublished           Boolean            @default(false)
  requiredGrades        Int[]              @default([])
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  instructorAssignments CourseInstructor[]
  instructor            User               @relation("InstructorCourses", fields: [instructorId], references: [id])
  enrollments           Enrollment[]
  modules               Module[]
  quizzes               Quiz[]
  assignments           Assignment[]
  notes                 Note[]             // NEW: Course-level notes
  omrSheets             OMRSheet[]         // OMR sheets for this course

  @@index([instructorId])
  @@index([category])
  @@map("courses")
}

model CourseInstructor {
  id           String   @id @default(uuid())
  courseId     String
  instructorId String
  assignedAt   DateTime @default(now())
  course       Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  instructor   User     @relation(fields: [instructorId], references: [id], onDelete: Cascade)

  @@unique([courseId, instructorId])
  @@index([instructorId])
  @@map("course_instructors")
}

model Module {
  id        String   @id @default(uuid())
  courseId  String
  title     String
  content   String?
  videoUrl  String?
  pdfUrl    String?  // NEW: PDF content support
  order     Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  progress  ContentProgress[]  // NEW: Track user progress on this module
  notes     Note[]             // NEW: User notes on this module

  @@index([courseId])
  @@map("modules")
}

model Enrollment {
  id          String    @id @default(uuid())
  userId      String
  courseId    String
  progress    Float     @default(0)
  completedAt DateTime?
  enrolledAt  DateTime  @default(now())
  enrolledBy  String?
  course      Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  assignedBy  User?     @relation("EnrollmentAssignedBy", fields: [enrolledBy], references: [id])
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
  @@map("enrollments")
}

model Quiz {
  id               String        @id @default(uuid())
  courseId         String?
  title            String
  description      String?
  duration         Int?
  passingScore     Float         @default(60)
  isPublished      Boolean       @default(false)
  shuffleQuestions Boolean       @default(false)
  showResults      Boolean       @default(true)
  requireSEB       Boolean       @default(false)
  isOMR            Boolean       @default(false)  // OMR quiz flag
  startDate        DateTime?
  endDate          DateTime?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  questions        Question[]
  attempts         QuizAttempt[]
  course           Course?       @relation(fields: [courseId], references: [id])
  omrSheets        OMRSheet[]    // OMR sheets for this quiz

  @@index([courseId])
  @@map("quizzes")
}

model Question {
  id            String       @id @default(uuid())
  quizId        String
  type          QuestionType
  content       String
  options       Json?
  correctAnswer Json
  points        Float        @default(1)
  order         Int
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  quiz          Quiz         @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@index([quizId])
  @@map("questions")
}

model Assignment {
  id          String   @id @default(uuid())
  courseId    String
  title       String
  description String?
  dueDate     DateTime?
  points      Float    @default(100)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  submissions AssignmentSubmission[]

  @@index([courseId])
  @@map("assignments")
}

model AssignmentSubmission {
  id           String   @id @default(uuid())
  assignmentId String
  studentId    String
  content      String?  // Text submission or URL
  fileUrl      String?  // File upload
  submittedAt  DateTime @default(now())
  grade        Float?
  feedback     String?
  assignment   Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  student      User     @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([assignmentId, studentId])
  @@index([assignmentId])
  @@index([studentId])
  @@map("assignment_submissions")
}

model QuizAttempt {
  id          String    @id @default(uuid())
  quizId      String
  userId      String
  answers     Json
  score       Float?
  isPassed    Boolean?
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  quiz        Quiz      @relation(fields: [quizId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([quizId])
  @@index([userId])
  @@map("quiz_attempts")
}

model AuditLog {
  id         String   @id @default(uuid())
  userId     String?
  action     String
  resource   String?
  resourceId String?
  details    Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())
  user       User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

model ContentProgress {
  id             String   @id @default(uuid())
  userId         String
  moduleId       String
  contentType    String   // 'video' | 'pdf' | 'document'
  progress       Float    @default(0) // For video: seconds watched | For PDF: page number
  totalDuration  Float?   // Total duration/pages for percentage calculation
  completed      Boolean  @default(false)
  videoCompleted Boolean  @default(false)  // NEW: Track video completion
  pdfCompleted   Boolean  @default(false)  // NEW: Track PDF completion
  lastPosition   Float?   // Last watched position (for resume)
  lastAccessedAt DateTime @updatedAt
  createdAt      DateTime @default(now())
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  module         Module   @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@unique([userId, moduleId])
  @@index([userId])
  @@index([moduleId])
  @@map("content_progress")
}

model Note {
  id        String   @id @default(uuid())
  userId    String
  moduleId  String?
  courseId  String?
  title     String?  // Optional note title
  content   String   // Note text
  timestamp Float?   // For video notes - timestamp in seconds
  pageNumber Int?    // For PDF notes - page number
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  module    Module?  @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  course    Course?  @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([moduleId])
  @@index([courseId])
  @@map("notes")
}

enum Role {
  SUPER_ADMIN
  ADMIN
  INSTRUCTOR
  ASSISTANT
  STUDENT
  GUEST
}

enum QuestionType {
  MULTIPLE_CHOICE
  TRUE_FALSE
  FILL_IN_BLANK
  SHORT_ANSWER
  LONG_ANSWER
  FILE_UPLOAD
  MATCHING
  ORDERING
}

model OMRSheet {
  id            String    @id @default(uuid())
  instructorId  String
  studentId     String?   // Optional: NULL if not linked yet
  courseId      String?   // Optional: Course association
  quizId        String?   // Optional: NULL if not linked yet
  imageUrl      String    // Stored scanned image
  rawData       Json?     // Raw processing data (for debugging)
  status        OMRStatus @default(PENDING)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  instructor    User      @relation("InstructorOMRSheets", fields: [instructorId], references: [id])
  student       User?     @relation("StudentOMRSheets", fields: [studentId], references: [id])
  course        Course?   @relation(fields: [courseId], references: [id])
  quiz          Quiz?     @relation(fields: [quizId], references: [id])
  result        OMRResult?
  
  @@index([instructorId])
  @@index([studentId])
  @@index([courseId])
  @@index([quizId])
  @@map("omr_sheets")
}

model OMRResult {
  id          String   @id @default(uuid())
  sheetId     String   @unique
  answers     Json     // { "1": "A", "2": "B", "3": "C", ... }
  confidence  Json?    // Confidence scores per question
  testId      String?  // Extracted TEST ID (Phase 2)
  rollNo      String?  // Extracted ROLL NO (Phase 2)
  validated   Boolean  @default(false)
  validatedBy String?
  validatedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  sheet       OMRSheet @relation(fields: [sheetId], references: [id], onDelete: Cascade)
  
  @@index([sheetId])
  @@map("omr_results")
}

enum OMRStatus {
  PENDING      // Uploaded, not processed
  PROCESSING   // Being processed
  COMPLETED    // Successfully processed
  VALIDATION   // Needs manual validation
  SUBMITTED    // Submitted to quiz system
  FAILED       // Processing failed
}


